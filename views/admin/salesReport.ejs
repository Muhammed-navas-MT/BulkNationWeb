<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Evara Dashboard</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <!-- Favicon -->
    <!-- <link rel="shortcut icon" type="image/x-icon" href="/backend/assets/imgs/theme/favicon.svg"> -->
    <!-- Template CSS -->
    <link href="/backend/assets/css/main.css" rel="stylesheet" type="text/css" />
    <style>
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .card {
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
        }
        .card-blue { background-color: #3b82f6; }
        .card-green { background-color: #10b981; }
        .card-cyan { background-color: #06b6d4; }
        .card-orange { background-color: #f97316; }
        .report-form {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .form-group select, .form-group input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
        }

        @media print {
        body * {
            display: none; 
        }
        table, table * {
            display: table; 
            visibility: visible; 
        }
        table {
            margin: 0 auto; 
            width: 100%; 
            border-collapse: collapse; 
        }
        table th, table td {
            padding: 8px; 
            text-align: left;
        }
    }
    </style>
</head>

<body>
    <div class="screen-overlay"></div>
    <aside class="navbar-aside" id="offcanvas_aside">
        <div class="aside-top">
            <a href="/admin" class="brand-wrap">
                <h1 style="color: black; text-decoration: none;">Bulk Nation</h1>
            </a>
            <div>
                <button class="btn btn-icon btn-aside-minimize"> <i class="text-muted material-icons md-menu_open"></i> </button>
            </div>
        </div>
        <nav>
            <ul class="menu-aside">
                <li class="menu-item">
                    <a class="menu-link" href="/admin"> <i class="icon material-icons md-home"></i>
                        <span class="text">Dashboard</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/product"> <i class="icon material-icons md-shopping_bag"></i>
                        <span class="text">Products</span> </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/order"> <i class="icon material-icons md-shopping_cart"></i>
                        <span class="text">Order</span> </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/users"> <i class="icon material-icons md-store"></i>
                        <span class="text">Users</span> </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/stockManagement"> <i class="icon material-icons md-add_box"></i>
                        <span class="text">Stock Managenet</span> </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/category"> <i class="icon material-icons md-stars"></i>
                        <span class="text">Categories</span> </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/brands"> <i class="icon material-icons md-stars"></i>
                        <span class="text">Brands</span> </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/coupon"> <i class="icon material-icons md-monetization_on"></i>
                        <span class="text">Coupons</span> </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/reason"> <i class="icon material-icons md-person"></i>
                        <span class="text">Return Request</span> </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/salesReport"> <i class="icon material-icons md-comment"></i>
                        <span class="text">Sales Report</span>
                    </a>
                </li>
            </ul>
            <hr>
            <ul class="menu-aside">
                <li class="menu-item has-submenu">
                    <a class="menu-link" href="#"> <i class="icon material-icons md-settings"></i>
                        <span class="text">Settings</span>
                    </a>
                </li>
            </ul>
            <br>
            <br>
        </nav>
    </aside>
    <main class="main-wrap">
        <header class="main-header navbar">
            <div class="col-search">
                <!-- <form class="searchform">
                    <div class="input-group">
                        <input list="search_terms" type="text" class="form-control" placeholder="Search term">
                        <button class="btn btn-light bg" type="button"> <i class="material-icons md-search"></i></button>
                    </div>
                    <datalist id="search_terms">
                        <option value="Products">
                        <option value="New orders">
                        <option value="Categories">
                        <option value="Users">
                    </datalist>
                </form> -->
            </div>
            <div class="col-nav">
                <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"> <i class="material-icons md-apps"></i> </button>
                <ul class="nav">
                    <li class="dropdown nav-item">
                        <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount" aria-expanded="false"> <img class="img-xs rounded-circle" src="/backend/assets/imgs/people/avatar2.jpg" alt="User"></a>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item text-danger" href="/admin/logout"><i class="material-icons md-exit_to_app"></i>Logout</a>
                        </div>
                    </li>
                </ul>
            </div>
        </header>

        <section class="content-main">
            <div class="content-header">
                <h2 class="content-title">Sales Report</h2>
            </div>

            <div class="card-grid">
                <div class="card card-blue">
                    <h2>Overall Sales</h2>
                    <p class="amount">₹<%=totalOrderAmount%></p>
                    <p class="description">After discounts & deductions</p>
                </div>
                <div class="card card-green">
                    <h2>Total Orders</h2>
                    <p class="amount"><%= totalSalesCount%></p>
                    <p class="description">Completed orders</p>
                </div>
                <div class="card card-cyan">
                    <h2>Total Discounts</h2>
                    <p class="amount">₹<%= totalDiscount%></p>
                    <p class="description">All discounts</p>
                </div>
                <!-- <div class="card card-orange">
                    <h2>Net Revenue</h2>
                    <p class="amount">₹55446.46</p>
                    <p class="description">After all deductions</p>
                </div> -->
            </div>

            <div class="report-form">
                
                    <div class="form-grid">
                        <!-- <div class="form-group">
                            <label for="report-type">Report Type</label>
                            <select id="report-type" name="report-type">
                                <option value="">Select Report Type</option>
                                <option value="sales">Sales Report</option>
                                <option value="orders">Orders Report</option>
                                <option value="products">Products Report</option>
                            </select>
                        </div> -->
                        <div class="form-group">
                            <label for="quick-select">Quick Select</label>
                            <select id="quick-select" name="quick-select">
                                <option value="1"> Today</option>
                                <!-- <option value="7">Weekly</option> -->
                                <option value="30" selected>Monthly</option>
                                <option value="365">Yearly</option>
                            </select>
                        </div>
                        <form id="filter-form">
                        <div class="form-group">
                            <label for="start-date">Start Date</label>
                            <input type="date" id="start-date" name="start-date">
                        </div>
                        <div class="form-group">
                            <label for="end-date">End Date</label>
                            <input type="date" id="end-date" name="end-date">
                        </div>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary">Generate Report</button>
                    </div>
                </form>
                <br>
            <button type="button" class="btn btn-light"  onclick="printTableRows()">Download PDF</button>
            <!-- <button type="button" class="btn btn-light">Download Excel</button> -->
            </div>
            <div class="card mt-4">
                <div class="card-body">
                    <div class="table-responsive">
                        <!-- <div class="row mb-4">
                            <div class="col-md-4">
                                <h5>Total Sales: ₹38034.30</h5>
                            </div>
                            <div class="col-md-4 text-center">
                                <h5>Total Orders: 33</h5>
                            </div>
                            <div class="col-md-4 text-end">
                                <h5>Total Discounts: ₹216.70</h5>
                            </div>
                        </div> -->
                        <table class="table table-hover">
                            <thead class="bg-light">
                              <tr>
                                <th>Order ID</th>
                                <th>Customer Name</th>
                                <th>Final Amount</th>
                                <th>Discount</th>
                                <th>Created On</th>
                              </tr>
                            </thead>
                            <tbody>
                              <% orders.forEach(order => { %>
                                <tr>
                                  <td><%= order.orderId %></td>
                                  <td><%= order.userId ? order.userId.username : "Unknown" %></td>
                                  <td>₹<%= order.finalAmount %></td>
                                  <td>
                                    <%= order.discount ? `₹${order.discount}` : "₹0" %>
                                  </td>
                                  <td><%= new Date(order.createdOn).toLocaleString() %></td>
                                </tr>
                              <% }) %>
                            </tbody>
                          </table>
                          
                        <!-- <nav class="mt-4">
                            <ul class="pagination justify-content-center">
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item"><a class="page-link" href="#">4</a></li>
                                <li class="page-item"><a class="page-link" href="#">Next</a></li>
                            </ul>
                        </nav> -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="/backend/assets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="/backend/assets/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="/backend/assets/js/vendors/select2.min.js"></script>
    <script src="/backend/assets/js/vendors/perfect-scrollbar.js"></script>
    <script src="/backend/assets/js/vendors/jquery.fullscreen.min.js"></script>
    <script src="/backend/assets/js/vendors/chart.js"></script>
    <!-- Main Script -->
    <script src="/backend/assets/js/main.js" type="text/javascript"></script>
    <script src="/backend/assets/js/custom-chart.js" type="text/javascript"></script>
<script> 
    document.addEventListener("DOMContentLoaded", () => {
  async function fetchFilteredOrders(quickSelect, startDate, endDate) {
    try {
      let queryParams = new URLSearchParams();
      if (quickSelect) queryParams.append("quickSelect", quickSelect);
      if (startDate) queryParams.append("startDate", startDate);
      if (endDate) queryParams.append("endDate", endDate);

      const response = await fetch(`/admin/orders?${queryParams.toString()}`);
      const data = await response.json();

      if (response.ok && data.success) {
        updateOrderTable(data.orders);
      } else {
        console.error("Failed to fetch orders:", data.message || "Unknown error");
      }
    } catch (error) {
      console.error("Error fetching orders:", error);
    }
  }

  function updateOrderTable(orders) {
    const tableBody = document.querySelector("table tbody");
    tableBody.innerHTML = ""; // Clear existing rows

    if (orders.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5">No orders found</td></tr>`;
      return;
    }

    orders.forEach(order => {
      const row = `
        <tr>
          <td>${order.orderId}</td>
          <td>${order.userId.username || "N/A"}</td>
          <td>₹${order.finalAmount}</td>
          <td>${order.discount ? `₹${order.discount}` : "₹0"}</td>
          <td>${new Date(order.createdOn).toLocaleString()}</td>
        </tr>
      `;
      tableBody.innerHTML += row;
    });
  }

  // Quick Select Filter
  document.getElementById("quick-select").addEventListener("change", (event) => {
    fetchFilteredOrders(event.target.value);
  });

  // Date Range Filter
  document.getElementById("filter-form").addEventListener("submit", (event) => {
    event.preventDefault();
    const startDate = document.getElementById("start-date").value;
    const endDate = document.getElementById("end-date").value;
    fetchFilteredOrders(null, startDate, endDate);
  });
});
   

function printTableRows() {
        const tableContent = document.querySelector("table").outerHTML; 
        const newWindow = window.open("", "_blank");
        newWindow.document.write(`
            <html>
                <head>
                    <title>Print Table</title>
                    <style>
                        table {
                            margin: 0 auto; 
                            width: 100%;
                            border-collapse: collapse;
                        }
                        table th, table td {
                            border: 1px solid red;
                            padding: 8px;
                            text-align: left;
                        }
                    </style>
                </head>
                <body>
                    ${tableContent}
                </body>
            </html>
        `);
        newWindow.document.close(); 
        newWindow.print(); 
        newWindow.close();
    }
    </script>
    
</body>

</html>